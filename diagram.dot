digraph {
    rankdir=LR;
    node [shape=box];

    {
        node [style=filled,fillcolor=lightyellow];

        // session canonicalization to detect duplicate flows?
        "plan.knit";
        {
            rank=same;
            // .knit/sessions/xxxx
            session;
            // .knit/cas/xx/yyyy
            cas;
            // .knit/jobcache/xx/yyyy
            // TODO this seems more appropriate on the workdir
            // .knit/jobcache/xx/yyyy.pending
            jobcache;
        }
        // .knit/workdirs/xx/yyyy
        workdir;
    }

    "plan.knit" -> session [label="parse\nbuild"];
    "plan.knit" -> resources;
    step -> job [label="resolve\ncompile"];
    job -> jobcache [label=check];
    job -> step [label="fulfill\nproduce"];
    session -> step [label=list];
    session -> invocation [label=close];

    // dispatch
    job -> workdir [label=unpack];
    workdir -> production [label="pack\nassemble\nbundle"];
    production -> jobcache [label=complete];

    {
        edge [style=dotted,arrowhead=empty];
        resources -> cas;
        job -> cas;
        production -> cas;
        invocation -> cas;
    }

    // step states
    blocked;
    resolvable [label="resolvable\navailable\napplicant\nprospect\nunblocked\nfree"];
    prepared [label="prepared\nprovisioned\ncompiled\nassembled"];
    blocked -> resolvable;
    resolvable -> prepared [label="resolve\ncompile\nassemble"];
    prepared -> "fulfilled\nproduced\nconcluded\nclosed";
    blocked -> "unresolvable\nmissing dependencies";

    // step flags
    NONE -> SS_JOB -> "SS_JOB|SS_FINAL";
    NONE -> SS_FINAL;

    // job states
    processing [label="processing\nactive"];
    idle -> processing -> complete;
    processing -> canceled [label=terminate];
    processing -> idle [label=lost];

    { rank=same; idle; NONE; job; }
}
